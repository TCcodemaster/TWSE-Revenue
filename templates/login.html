<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8" />
  <title>Login & Sign up</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css?family=Fira+Sans" rel="stylesheet">
  <!-- 自定義 CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/login.css') }}">

</head>

<body>
  <div class="outer-container">
    <div class="inner-wrapper">
      <!-- 左側：表單區 -->
      <div class="left-panel">
        <div class="form-structor">
          <!-- 登入區塊 -->
          <div class="system-name">
            <span>TWSE 公司月營收查詢系統</span>
          </div>
          <div class="login" id="login-section">
            <h2 class="form-title" id="login">Log in</h2>
            <form id="login-form" method="post" action="{{ url_for('login') }}">
              <!-- 提示訊息放在使用者名稱上方 -->
              <div id="popup-login" class="popup"></div>
              <div class="form-holder">
                <input type="text" class="input" name="username" placeholder="Username" required />
                <input type="password" class="input" name="password" placeholder="Password" required />
              </div>
              <button type="submit" class="submit-btn">Log in</button>
            </form>
            <!-- Google 登入按鈕 -->
            <!-- 正確的分隔線實現 -->
            <div class="divider">
              <span>OR</span>
            </div>

            <div class="social-login">
              <a href="{{ url_for('google.login') }}" class="btn btn-social btn-google">

                <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google" class="social-icon"
                  width="18" height="18">
                <span>Continue with Google</span>
              </a>
            </div>
            <p class="toggle-text">
              Don’t have an account?
              <a href="#" id="toSignUp">Sign up</a>
            </p>
          </div>
          <!-- 註冊區塊 -->
          <div class="signup" id="signup-section">
            <h2 class="form-title" id="signup">Sign up</h2>
            <form id="register-form" method="post" action="{{ url_for('register') }}">
              <!-- 提示訊息放在使用者名稱上方 -->
              <div id="popup-register" class="popup"></div>
              <div class="form-holder">
                <input type="text" class="input" name="username" placeholder="Name" required />
                <input type="email" class="input" name="email" placeholder="Email" required />
                <input type="password" class="input" name="password" placeholder="Password" required />


                <input type="password" class="input" name="confirm_password" placeholder="Confirm Password" required />
              </div>
              <button type="submit" class="submit-btn">Sign up</button>
            </form>

            <p class="toggle-text">
              Already have an account?
              <a href="#" id="toLogIn">Log in</a>
            </p>
          </div>
        </div>
      </div>
      <!-- 右側：動畫背景 -->
      <div class="right-panel">
        <svg id="animated-bg" viewBox="0 0 800 800" preserveAspectRatio="xMidYMid slice">
          <!-- 背景 -->
          <rect width="800" height="800" fill="#1E1E2F" />

          <!-- 主要數據網格 -->
          <g id="grid">
            <!-- 水平線 -->
            <line x1="100" y1="200" x2="700" y2="200" stroke="#2a2a45" stroke-width="1" />
            <line x1="100" y1="300" x2="700" y2="300" stroke="#2a2a45" stroke-width="1" />
            <line x1="100" y1="400" x2="700" y2="400" stroke="#2a2a45" stroke-width="1" />
            <line x1="100" y1="500" x2="700" y2="500" stroke="#2a2a45" stroke-width="1" />
            <line x1="100" y1="600" x2="700" y2="600" stroke="#2a2a45" stroke-width="1" />

            <!-- 垂直線 -->
            <line x1="100" y1="200" x2="100" y2="600" stroke="#2a2a45" stroke-width="1" />
            <line x1="200" y1="200" x2="200" y2="600" stroke="#2a2a45" stroke-width="1" />
            <line x1="300" y1="200" x2="300" y2="600" stroke="#2a2a45" stroke-width="1" />
            <line x1="400" y1="200" x2="400" y2="600" stroke="#2a2a45" stroke-width="1" />
            <line x1="500" y1="200" x2="500" y2="600" stroke="#2a2a45" stroke-width="1" />
            <line x1="600" y1="200" x2="600" y2="600" stroke="#2a2a45" stroke-width="1" />
            <line x1="700" y1="200" x2="700" y2="600" stroke="#2a2a45" stroke-width="1" />
          </g>

          <!-- 數據線 1: 主要月營收趨勢 -->
          <path id="data-line1" d="M100,400 L200,380 L300,350 L400,320 L500,340 L600,310 L700,280" stroke="#4AE0D5"
            stroke-width="2.5" fill="none" stroke-linecap="round" />

          <!-- 數據線 2: 次要趨勢比較 -->
          <path id="data-line2" d="M100,450 L200,440 L300,460 L400,430 L500,450 L600,420 L700,440" stroke="#3498db"
            stroke-width="2" fill="none" opacity="0.8" stroke-linecap="round" />

          <!-- 數據點 -->
          <g id="data-points-1">
            <circle cx="100" cy="400" r="4" fill="#4AE0D5" />
            <circle cx="200" cy="380" r="4" fill="#4AE0D5" />
            <circle cx="300" cy="350" r="4" fill="#4AE0D5" />
            <circle cx="400" cy="320" r="4" fill="#4AE0D5" />
            <circle cx="500" cy="340" r="4" fill="#4AE0D5" />
            <circle cx="600" cy="310" r="4" fill="#4AE0D5" />
            <circle cx="700" cy="280" r="4" fill="#4AE0D5" />
          </g>

          <g id="data-points-2">
            <circle cx="100" cy="450" r="3.5" fill="#3498db" />
            <circle cx="200" cy="440" r="3.5" fill="#3498db" />
            <circle cx="300" cy="460" r="3.5" fill="#3498db" />
            <circle cx="400" cy="430" r="3.5" fill="#3498db" />
            <circle cx="500" cy="450" r="3.5" fill="#3498db" />
            <circle cx="600" cy="420" r="3.5" fill="#3498db" />
            <circle cx="700" cy="440" r="3.5" fill="#3498db" />
          </g>

          <!-- 突出顯示區域 -->
          <path id="highlight-area" d="M400,320 L500,340 L600,310 L700,280 L700,600 L400,600 Z" fill="#4AE0D5"
            opacity="0.05" />

          <!-- 動態掃描線 -->
          <line id="scan-line" x1="100" y1="200" x2="100" y2="600" stroke="#4AE0D5" stroke-width="1.5" opacity="0.7" />

          <!-- 浮動數據標籤 -->
          <g id="data-labels">
            <circle cx="400" cy="320" r="8" fill="#1E1E2F" stroke="#4AE0D5" stroke-width="1.5" />
            <circle cx="600" cy="310" r="8" fill="#1E1E2F" stroke="#4AE0D5" stroke-width="1.5" />
          </g>

          <!-- 裝飾性元素: 抽象數據視覺化 -->
          <g id="decorative-elements">
            <path
              d="M750,150 C760,160 760,180 750,190 C740,200 720,200 710,190 C700,180 700,160 710,150 C720,140 740,140 750,150"
              stroke="#4AE0D5" stroke-width="1.5" fill="none" />
            <path d="M50,650 C60,660 60,680 50,690 C40,700 20,700 10,690 C0,680 0,660 10,650 C20,640 40,640 50,650"
              stroke="#3498db" stroke-width="1.5" fill="none" />
          </g>
        </svg>
      </div>
    </div>
  </div>
  <!-- 引入 anime.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
  <script>
    // 提示訊息函數（根據表單不同使用不同 id）
    // 提示訊息函數，加入淡入動畫
    function displayPopup(popupId, message, isSuccess) {
      const popup = document.getElementById(popupId);
      popup.style.display = 'block';
      popup.style.backgroundColor = isSuccess ? '#4caf50' : '#f44336';
      popup.style.color = '#fff';
      popup.textContent = message;
      // 觸發淡入動畫
      popup.style.animation = 'fadeIn 0.3s forwards';
    }
    // 淡出提示訊息
    function closePopup(popupId) {
      const popup = document.getElementById(popupId);
      // 播放淡出動畫，動畫結束後隱藏元素
      popup.style.animation = 'fadeOut 0.6s forwards';
      setTimeout(() => {
        popup.style.display = 'none';
      }, 300);
    }

    // 綁定登入表單提交事件
    const loginForm = document.getElementById('login-form');
    loginForm.addEventListener('submit', function (event) {
      event.preventDefault();
      const formData = new FormData(loginForm);

      // 添加明確的 AJAX 請求頭
      fetch(loginForm.action, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'  // 明確告知伺服器這是一個 AJAX 請求
        },
        credentials: 'include'
      })
        .then(response => {
          // 檢查響應狀態是否正常
          if (!response.ok) {
            throw new Error(`Server responded with status: ${response.status}`);
          }

          // 檢查內容類型
          const contentType = response.headers.get('content-type');
          if (contentType && contentType.includes('application/json')) {
            return response.json();
          } else {
            console.error('Received non-JSON response:', contentType);
            throw new Error('Response was not JSON as expected');
          }
        })
        .then(data => {
          if (data.success) {
            displayPopup('popup-login', data.message, true);
            setTimeout(function () {
              window.location.href = data.url;
            }, 700);
          } else {
            displayPopup('popup-login', data.message, false);
            setTimeout(function () {
              closePopup('popup-login');
            }, 1000);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          displayPopup('popup-login', "發生錯誤，請稍後再試", false);
        });
    });

    // 綁定註冊表單提交事件
    const registerForm = document.getElementById('register-form');
    registerForm.addEventListener('submit', function (event) {
      event.preventDefault();
      const formData = new FormData(registerForm);

      // 添加明確的 AJAX 請求頭
      fetch(registerForm.action, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'  // 明確告知伺服器這是一個 AJAX 請求
        },
        credentials: 'include'
      })
        .then(response => {
          // 檢查響應狀態是否正常
          if (!response.ok) {
            throw new Error(`Server responded with status: ${response.status}`);
          }

          // 檢查內容類型
          const contentType = response.headers.get('content-type');
          if (contentType && contentType.includes('application/json')) {
            return response.json();
          } else {
            console.error('Received non-JSON response:', contentType);
            throw new Error('Response was not JSON as expected');
          }
        })
        .then(data => {
          if (data.success) {
            displayPopup('popup-register', data.message, true);
            setTimeout(function () {
              window.location.href = data.url;
            }, 500);
          } else {
            displayPopup('popup-register', data.message, false);
            setTimeout(function () {
              closePopup('popup-register');
            }, 1000);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          displayPopup('popup-register', "發生錯誤，請稍後再試", false);
        });
    });
    // 切換登入與註冊區塊
    const loginSection = document.getElementById('login-section');
    const signupSection = document.getElementById('signup-section');
    const toSignUp = document.getElementById('toSignUp');
    const toLogIn = document.getElementById('toLogIn');

    toSignUp.addEventListener('click', (e) => {
      e.preventDefault();
      loginSection.style.opacity = '0';
      loginSection.style.pointerEvents = 'none';
      loginSection.style.zIndex = '1';

      signupSection.style.opacity = '1';
      signupSection.style.pointerEvents = 'auto';
      signupSection.style.zIndex = '2';
    });

    toLogIn.addEventListener('click', (e) => {
      e.preventDefault();
      signupSection.style.opacity = '0';
      signupSection.style.pointerEvents = 'none';
      signupSection.style.zIndex = '1';

      loginSection.style.opacity = '1';
      loginSection.style.pointerEvents = 'auto';
      loginSection.style.zIndex = '2';
    });

    // Anime.js 動畫設定
    document.addEventListener('DOMContentLoaded', function () {
      // 數據線條動畫
      anime({
        targets: ['#data-line1', '#data-line2'],
        strokeDashoffset: [anime.setDashoffset, 0],
        easing: 'easeInOutSine',
        duration: 3000,
        delay: function (el, i) { return i * 250 },
        opacity: {
          value: [0, 1],
          easing: 'linear',
          duration: 2000
        }
      });

      // 數據點出現動畫
      anime({
        targets: ['#data-points-1 circle', '#data-points-2 circle'],
        scale: [0, 1],
        opacity: [0, 1],
        easing: 'easeOutElastic(1, .5)',
        duration: 2000,
        delay: anime.stagger(100, { start: 2500 })
      });

      // 掃描線動畫
      anime({
        targets: '#scan-line',
        translateX: [0, 600],
        easing: 'linear',
        duration: 8000,
        loop: true,
        opacity: {
          value: [0.7, 0.2, 0.7],
          duration: 8000,
          easing: 'linear'
        }
      });

      // 突出顯示區域動畫
      anime({
        targets: '#highlight-area',
        opacity: [0, 0.05, 0.1, 0.05],
        easing: 'easeInOutQuad',
        duration: 4000,
        loop: true
      });

      // 數據標籤脈動
      anime({
        targets: '#data-labels circle',
        scale: [1, 1.2, 1],
        opacity: [0.7, 1, 0.7],
        easing: 'easeInOutQuad',
        duration: 3000,
        loop: true,
        delay: anime.stagger(1500)
      });

      // 裝飾元素旋轉
      anime({
        targets: '#decorative-elements path',
        rotate: '1turn',
        duration: 15000,
        loop: true,
        easing: 'linear',
        transformOrigin: 'center center',
        delay: anime.stagger(2000)
      });
    });
  </script>
</body>

</html>